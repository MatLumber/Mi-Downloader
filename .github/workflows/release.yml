name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g. v1.0.4)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-release:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CSC_IDENTITY_AUTO_DISCOVERY: false
      ELECTRON_BUILDER_SKIP_WIN_CODESIGN: true
      NODE_OPTIONS: --max-old-space-size=8192
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout tag
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          git fetch --tags --force
          git checkout ${{ inputs.tag }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt pyinstaller

      - name: Download ffmpeg
        shell: powershell
        run: |
          $zip = "$env:RUNNER_TEMP\ffmpeg.zip"
          $dest = "$env:RUNNER_TEMP\ffmpeg"
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath $dest -Force
          $ffmpeg = Get-ChildItem -Path $dest -Recurse -Filter ffmpeg.exe | Select-Object -First 1
          $ffprobe = Get-ChildItem -Path $dest -Recurse -Filter ffprobe.exe | Select-Object -First 1
          New-Item -ItemType Directory -Path backend\ffmpeg -Force | Out-Null
          Copy-Item $ffmpeg.FullName backend\ffmpeg\ffmpeg.exe -Force
          Copy-Item $ffprobe.FullName backend\ffmpeg\ffprobe.exe -Force

      - name: Build backend
        working-directory: backend
        run: |
          pyinstaller --clean --noconfirm gravitydown.spec

      - name: Install frontend deps
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Build release artifacts
        working-directory: frontend
        run: npx electron-builder --win --x64 --publish=never

      - name: Validate latest.yml assets
        working-directory: frontend
        shell: bash
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const releaseDir = path.resolve('release');
          const latestPath = path.join(releaseDir, 'latest.yml');

          if (!fs.existsSync(latestPath)) {
            console.error(`latest.yml not found at ${latestPath}`);
            process.exit(1);
          }

          const content = fs.readFileSync(latestPath, 'utf8');
          const urls = [];
          const pathMatch = content.match(/^path:\s*(.+)\s*$/m);
          if (pathMatch) {
            urls.push(pathMatch[1].trim());
          }

          const urlRegex = /^\s*-\s*url:\s*(.+)\s*$/gm;
          let match;
          while ((match = urlRegex.exec(content)) !== null) {
            urls.push(match[1].trim());
          }

          const unique = Array.from(new Set(urls)).filter(Boolean);
          if (unique.length === 0) {
            console.error('No assets referenced in latest.yml');
            process.exit(1);
          }

          const missing = unique.filter((file) => !fs.existsSync(path.join(releaseDir, file)));
          if (missing.length) {
            console.error(`Missing assets referenced by latest.yml: ${missing.join(', ')}`);
            process.exit(1);
          }

          console.log(`latest.yml assets exist: ${unique.join(', ')}`);
          NODE

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          make_latest: true
          files: |
            frontend/release/*.exe
            frontend/release/*.yml
            frontend/release/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
